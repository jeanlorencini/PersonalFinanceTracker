{% extends "base.html" %}

{% block title %}Dashboard - Controle Financeiro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-900">Dashboard Financeiro</h2>
        <div class="text-sm text-gray-500">
            <i class="fas fa-calendar mr-1"></i>
            {{ moment().format('MMMM YYYY') if moment else 'Mês Atual' }}
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Income Card -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-arrow-up text-green-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Receita do Mês</dt>
                            <dd class="text-lg font-medium text-gray-900">
                                R$ {{ "%.2f"|format(monthly_income) }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expenses Card -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-arrow-down text-red-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Despesas do Mês</dt>
                            <dd class="text-lg font-medium text-gray-900">
                                R$ {{ "%.2f"|format(monthly_expenses) }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Card -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-wallet text-blue-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Saldo em Conta</dt>
                            <dd class="text-lg font-medium {{ 'text-green-600' if account_balance >= 0 else 'text-red-600' }}">
                                R$ {{ "%.2f"|format(account_balance) }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Investments Card -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-md flex items-center justify-center">
                            <i class="fas fa-chart-line text-purple-600"></i>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Investimentos do Mês</dt>
                            <dd class="text-lg font-medium text-gray-900">
                                R$ {{ "%.2f"|format(monthly_investments) }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts and Recent Transactions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Expenses Chart -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    Despesas por Categoria
                </h3>
                <div class="relative h-64">
                    {% if expenses_by_category %}
                        <canvas id="expensesChart"></canvas>
                    {% else %}
                        <div class="flex items-center justify-center h-full text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-chart-pie text-4xl mb-2"></i>
                                <p>Nenhuma despesa categorizada este mês</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    Transações Recentes
                </h3>
                <div class="space-y-3">
                    {% if recent_transactions %}
                        {% for transaction in recent_transactions %}
                            <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">
                                        {{ transaction.description }}
                                    </p>
                                    <p class="text-sm text-gray-500">
                                        {{ transaction.date.strftime('%d/%m/%Y') }}
                                        {% if transaction.type == 'receita' %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 ml-2">
                                                Receita
                                            </span>
                                        {% elif transaction.type == 'despesa' %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 ml-2">
                                                Despesa
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 ml-2">
                                                Transferência
                                            </span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="text-sm font-medium {{ 'text-green-600' if transaction.amount > 0 else 'text-red-600' }}">
                                    {{ '+' if transaction.amount > 0 else '' }}R$ {{ "%.2f"|format(transaction.amount) }}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-receipt text-4xl mb-2"></i>
                            <p>Nenhuma transação encontrada</p>
                            <a href="{{ url_for('import_page') }}" class="text-blue-600 hover:text-blue-800 text-sm mt-2 inline-block">
                                Importar extrato bancário
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize expenses chart if data exists
{% if expenses_by_category %}
const expensesData = {
    labels: {{ expenses_by_category | map('first') | list | tojson }},
    data: {{ expenses_by_category | map('last') | map('abs') | list | tojson }}
};

const ctx = document.getElementById('expensesChart');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: expensesData.labels,
        datasets: [{
            data: expensesData.data,
            backgroundColor: [
                '#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4',
                '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true
                }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
